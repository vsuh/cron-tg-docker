name: Build and push Docker image on new reminder-tgm tag

on:
  repository_dispatch:
    types: [new-reminder-tgm-tag]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check if release archive exists
        run: |
          curl -f -I "https://github.com/vsuh/reminder-tgm/archive/refs/tags/${{ github.event.client_payload.tag }}.tar.gz"

      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Update TAG in Dockerfile
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          sed -i '/^[[:space:]]*TAG=/s/TAG="[^"]*"/TAG="${{ github.event.client_payload.tag }}"/' Dockerfile
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Dockerfile
          git diff --cached --quiet || git commit -m "Update TAG to ${{ github.event.client_payload.tag }}"
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:${GITHUB_REF##*/}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

#      - name: Build and push Docker image
#        uses: docker/build-push-action@v5
#        with:
#          context: .
#          push: true
#          tags: vsuh/cron-tg-docker:${{ github.event.client_payload.tag }}


      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            vsuh/cron-tg-docker:${{ github.event.client_payload.tag }}
            vsuh/cron-tg-docker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Verify pushed images
        run: |
          echo "âœ… Successfully built and pushed:"
          echo "  - vsuh/cron-tg-docker:${{ github.event.client_payload.tag }}"
          echo "  - vsuh/cron-tg-docker:latest"

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            âœ… Build successful!

            ğŸ“¦ Image: vsuh/cron-tg-docker
            ğŸ· Tags: ${{ github.event.client_payload.tag }}, latest
            ğŸ”— Repo: ${{ github.repository }}
            ğŸ¯ Event: ${{ github.event_name }}
            ğŸ“ Commit message:
            ${{ github.event.client_payload.message }}
